# File: .github/workflows/reusable-build.yml
name: Reusable AUR Build

on:
  workflow_call:
    inputs:
      package:
        description: The package to build
        required: true
        type: string
      download-artifacts:
        description: Whether to download artifacts from previous jobs
        required: true
        type: boolean
      lto:
        description: Enable LTO
        default: true
        type: boolean
      gpg-sign:
        description: Use GPG sign
        default: true
        type: boolean
      clean-build:
        description: Launch a clean build
        default: false
        type: boolean
    secrets:
      GPG_SEC_KEY:
        required: true
      GPG_PASSPHRASE:
        required: true
      GPG_SIG_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: greyltc/archlinux-aur:yay
      options: --privileged # Required for system-level changes like useradd, pacman
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_SEC_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Prepare build environment
        if: ${{ inputs.lto && !inputs.clean-build }}
        run: |
          sed -i '/VerbosePkgLists/d' /etc/pacman.conf
          # cat ./configs/pacman.conf >> /etc/pacman.conf
          cat ./configs/makepkg.conf >> /etc/makepkg.conf
          pacman -Syu --noconfirm --overwrite '*' base-devel git pacman-contrib mold python-pyyaml sudo tree
          sed -i '/E_ROOT/d' /usr/bin/makepkg

      - name: Prepare build environment (No LTO)
        if: ${{ !inputs.lto && !inputs.clean-build }}
        run: |
          sed -i '/VerbosePkgLists/d' /etc/pacman.conf
          # cat ./configs/pacman.conf >> /etc/pacman.conf
          cat ./configs/makepkg-no-lto.conf >> /etc/makepkg.conf
          pacman -Syu --noconfirm --overwrite '*' base-devel git pacman-contrib mold python-pyyaml sudo tree
          sed -i '/E_ROOT/d' /usr/bin/makepkg

      - name: Prepare environment (Clean Build)
        if: ${{ inputs.clean-build }}
        run: |
          sed -i '/VerbosePkgLists/d' /etc/pacman.conf
          # cat ./configs/pacman.conf >> /etc/pacman.conf
          pacman -Syu --noconfirm --overwrite '*' base-devel git pacman-contrib mold python-pyyaml sudo tree
          sed -i '/E_ROOT/d' /usr/bin/makepkg

      # - name: Install paru
      #   run: |
      #     cd /tmp
      #     git clone https://aur.archlinux.org/paru-bin.git
      #     cd paru-bin
      #     makepkg -si --noconfirm --noprogressbar
      #     cd ..
      #     rm -rf paru-bin

      - name: Download previously built dependencies
        if: ${{ inputs.download-artifacts }}
        id: download-deps
        uses: actions/download-artifact@v4
        with:
          path: x86_64
          merge-multiple: true

      - name: Setup local repo for dependencies
        if: ${{ inputs.download-artifacts && steps.download-deps.outputs.download-path }}
        env:
          GPG_SIG_KEY: ${{ secrets.GPG_SIG_KEY }}
          GPG_SIGN: ${{ inputs.gpg-sign }}
        run: |
          echo "--- Setting up local repo with downloaded packages ---"
          bash scripts/repo-add.sh our-tmp
          echo "[our-tmp]" >> /etc/pacman.conf
          echo "SigLevel = Optional TrustAll" >> /etc/pacman.conf
          echo "Server = file://$(pwd)/x86_64" >> /etc/pacman.conf
          pacman -Syu --noconfirm --overwrite '*'

      # - name: Create non-root user
      #   run: |
      #     useradd -m -G wheel builder
      #     # Allow the 'builder' user to run any command with sudo without a password
      #     echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      #     chown -R builder:builder .

      - name: Build AUR package
        env:
          GPG_SIG_KEY: ${{ secrets.GPG_SIG_KEY }}
          GPG_SIGN: ${{ inputs.gpg-sign }}
        # 调用脚本，只传递一个包
        run: |
          bash scripts/build-one.sh ${{ inputs.package }}

      - name: Rename files with illegal characters
        run: |
          find . -maxdepth 1 -type f -name '*:*' | while IFS= read -r file; do mv "$file" "${file//:/_}"; done
      
      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package }} # 使用包名作为构件名，更清晰
          path: |
            *.zst*