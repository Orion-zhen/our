# File: .github/workflows/reusable-build.yml
name: Reusable AUR Build

on:
  workflow_call:
    inputs:
      package:
        description: The package to build
        required: true
        type: string
      lto:
        description: Enable LTO
        default: true
        type: boolean
      gpg-sign:
        description: Use GPG sign
        default: true
        type: boolean
      clean-build:
        description: Launch a clean build
        default: false
        type: boolean
      custom-env:
        description: Custom environment variables (one per line, KEY=VALUE format)
        required: false
        type: string
        default: ""
    secrets:
      GPG_SEC_KEY:
        required: true
      GPG_PASSPHRASE:
        required: true
      GPG_SIG_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 清理磁盘空间
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Build in Arch Linux Container
        # 使用 run 直接调用 Docker
        env:
          CUSTOM_ENV: ${{ inputs.custom-env }}
        run: |
          # 构建自定义环境变量参数
          CUSTOM_ENV_ARGS=""
          if [ -n "$CUSTOM_ENV" ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              # 跳过空行和注释行
              if [ -n "$line" ] && [[ ! "$line" =~ ^# ]]; then
                # 分离 KEY 和 VALUE
                key="${line%%=*}"
                value="${line#*=}"
                # 去除 VALUE 外层的双引号（如果存在）
                value="${value#\"}"
                value="${value%\"}"
                CUSTOM_ENV_ARGS="$CUSTOM_ENV_ARGS -e $key=$value"
              fi
            done <<< "$CUSTOM_ENV"
          fi
          
          docker run --privileged --rm \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            -e CI=1 \
            -e INPUT_LTO="${{ inputs.lto }}" \
            -e INPUT_CLEAN_BUILD="${{ inputs.clean-build }}" \
            $CUSTOM_ENV_ARGS \
            archlinux:latest \
            /bin/bash -c "chmod +x scripts/entrypoint.sh && ./scripts/entrypoint.sh ${{ inputs.package }}"

      - name: Fix Permissions
        if: always()
        run: |
          sudo chown -R $USER:$USER .

      - name: Import GPG key
        if: ${{ inputs.gpg-sign }}
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_SEC_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: GPG Sign Packages
        env:
          GPG_SIG_KEY: ${{ secrets.GPG_SIG_KEY }}
        if: ${{ inputs.gpg-sign }}
        run: |
          for pkg in *.zst; do
            echo "signing $pkg..."
            gpg --local-user $GPG_SIG_KEY --detach-sign "$pkg"
          done

          echo "Every package is signed"

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.package }} # 使用包名作为构件名，更清晰
          path: |
            *.zst*
